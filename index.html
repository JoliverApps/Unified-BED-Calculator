<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Unified BED Calculator (RD Framework)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <script id="data-source-script" src="./datasrc.js"></script>
  <script>
    window.MathJax = {
      tex: { inlineMath: [['\\(','\\)'], ['$', '$']] },
      options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .error-message { color: #ef4444; font-size: 0.875rem; min-height: 1.25rem; transition: opacity .3s; }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }
    details > summary { cursor: pointer; }
    input[aria-invalid="true"] { border-color: #ef4444; }
    input[aria-invalid="true"]:focus { --tw-ring-color: #ef4444; border-color: #ef4444; }
    
    /* Animation for source box */
    .fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>

<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

  <div class="w-full max-w-lg bg-white rounded-xl shadow-lg p-6 md:p-8 space-y-6">
    
    <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-lg">
      <p class="font-bold text-xs uppercase tracking-wide">Research Tool</p>
      <p class="text-xs mt-1">Parameters are derived from historical $D_0$ and LQ data via the $r = 1 - \alpha D_0$ translation. Not validated for clinical use.</p>
    </div>

    <div class="text-center">
      <h1 class="text-2xl md:text-3xl font-bold text-slate-800">Unified BED Calculator</h1>
      <p class="text-slate-500 mt-2 text-sm">RD Framework (Isoeffect via Lambert-$W$)</p>
      <div class="my-3 text-sm overflow-x-auto text-slate-600">
        $$ \mathrm{BED}(D,n) = \frac{D}{1-r} - \frac{n D_q}{1-r}\Bigl(1-e^{-s D/n}\Bigr) $$
      </div>
    </div>

    <div class="space-y-4">
      <h2 class="text-lg font-semibold text-slate-700 border-b pb-1">1. Tumor Parameters</h2>
      
      <div>
        <div class="flex items-center justify-between gap-4">
          <label for="cell-line-select" class="text-sm font-medium text-slate-600">Preset:</label>
          <select id="cell-line-select" class="w-3/5 md:w-2/3 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition text-sm">
            <option value="">Loading data...</option>
          </select>
        </div>
        
        <p id="cell-desc" class="text-xs text-slate-400 mt-2 italic text-right min-h-[1rem]"></p>

        <div id="source-box" class="hidden mt-2 p-3 bg-slate-50 border border-slate-200 rounded text-xs text-slate-600 fade-in">
            <span class="font-bold text-slate-700">Source:</span> <span id="source-text"></span>
        </div>
      </div>

      <div class="grid grid-cols-3 gap-2">
        <div>
          <label class="block text-xs font-medium text-slate-500 mb-1">Resilience \(r\)</label>
          <input type="number" id="param-r" step="any" class="w-full px-2 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm" placeholder="0.9">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-500 mb-1">Sens. \(s\) (1/Gy)</label>
          <input type="number" id="param-s" step="any" class="w-full px-2 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm" placeholder="0.2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-500 mb-1">Slope \(k\) (1/Gy)</label>
          <input type="number" id="param-k" step="any" disabled class="w-full px-2 py-2 border border-slate-300 rounded-lg bg-slate-100 text-slate-400 cursor-not-allowed text-sm">
        </div>
      </div>
      <span id="error-params" class="error-message block text-center"></span>
    </div>

    <div class="space-y-4 p-4 bg-slate-50 border border-slate-200 rounded-lg">
      <h2 class="text-lg font-semibold text-slate-700">2. Reference Schedule</h2>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="text-sm font-medium text-slate-600">Total Dose \(D_1\)</label>
          <input type="number" id="dose-d1" class="w-full mt-1 px-3 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 text-sm" placeholder="e.g., 60">
        </div>
        <div>
          <label class="text-sm font-medium text-slate-600">Fractions \(n_1\)</label>
          <input type="number" id="fractions-n1" class="w-full mt-1 px-3 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 text-sm" placeholder="e.g., 30">
        </div>
      </div>
      <div class="text-xs text-right text-slate-500">
        Dose/Fx: <span id="original-dpf" class="font-bold">--</span> Gy
      </div>
    </div>

    <div class="space-y-2">
      <h2 class="text-lg font-semibold text-slate-700">3. Target Schedule</h2>
      <div class="flex items-center justify-between gap-4">
        <label class="text-sm font-medium text-slate-600">New Fractions \(n_2\):</label>
        <input type="number" id="fractions-n2" class="w-1/3 px-3 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 text-sm" placeholder="e.g., 5">
      </div>
    </div>

    <button id="calculate-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 shadow-lg transition-transform transform active:scale-95">
      Calculate Equivalence
    </button>

    <div id="result-container" class="hidden animate-fade-in mt-6">
      <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-6 text-center">
        <h3 class="text-xs uppercase tracking-wide text-indigo-500 font-bold">Required Total Dose \(D_2\)</h3>
        <p id="result-text" class="text-4xl font-bold text-indigo-700 my-2"></p>
        <p id="dose-per-fraction-text" class="text-lg text-indigo-600 font-medium"></p>
      </div>
      
      <details class="mt-4 border border-slate-200 rounded-lg">
        <summary class="text-xs text-slate-500 p-2 hover:bg-slate-50 font-medium">Show Calculation Details</summary>
        <div class="text-xs text-slate-500 font-mono bg-slate-50 p-3 rounded-b-lg space-y-1">
          <p>BED_ref: <span id="dbg-bed1"></span> Gy</p>
          <p>K_iso: <span id="dbg-k"></span></p>
          <p>W(z): <span id="dbg-w"></span></p>
        </div>
      </details>
    </div>

    <div class="text-center text-xs text-slate-400 pt-6 border-t border-slate-200">
      <p>Data Source: <a href="./datasrc.js" target="_blank" class="underline hover:text-slate-600">datasrc.js</a> | <a href="https://github.com/JoliverApps/Unified-BED-Calculator" class="underline hover:text-slate-600">GitHub Repository</a></p>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    
    // --- 1. Load Data Source ---
    const cellSelect = document.getElementById('cell-line-select');
    const cellDesc = document.getElementById('cell-desc');
    const sourceBox = document.getElementById('source-box');
    const sourceText = document.getElementById('source-text');
    
    // Check if data loaded
    setTimeout(() => {
        if (typeof window.RD_DATA !== 'undefined') {
            cellSelect.innerHTML = '<option value="">— Select Tumor Type —</option>';
            // Sort keys alphabetically
            Object.keys(window.RD_DATA).sort().forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = key;
                cellSelect.appendChild(opt);
            });
        } else {
            cellSelect.innerHTML = '<option value="">Error: datasrc.js not found</option>';
        }
    }, 100);

    // --- 2. Math & Logic ---
    const inputs = {
        r: document.getElementById('param-r'),
        s: document.getElementById('param-s'),
        k: document.getElementById('param-k'),
        d1: document.getElementById('dose-d1'),
        n1: document.getElementById('fractions-n1'),
        n2: document.getElementById('fractions-n2')
    };

    // Auto-fill parameters & Update Source Box
    cellSelect.addEventListener('change', () => {
        const key = cellSelect.value;
        if (key && window.RD_DATA[key]) {
            const data = window.RD_DATA[key];
            inputs.r.value = data.r;
            inputs.s.value = data.s;
            inputs.k.value = data.k;
            cellDesc.textContent = data.desc || "";
            
            // Check for source and update box
            if(data.source) {
                sourceText.innerHTML = data.source;
                sourceBox.classList.remove('hidden');
            } else {
                sourceBox.classList.add('hidden');
            }
        } else {
            inputs.r.value = '';
            inputs.s.value = '';
            inputs.k.value = '';
            cellDesc.textContent = "";
            sourceBox.classList.add('hidden');
        }
    });

    // Update DPF Label
    function updateDpf() {
        const d = parseFloat(inputs.d1.value);
        const n = parseFloat(inputs.n1.value);
        const lbl = document.getElementById('original-dpf');
        if (d > 0 && n > 0) lbl.textContent = (d/n).toFixed(2);
        else lbl.textContent = "--";
    }
    inputs.d1.addEventListener('input', updateDpf);
    inputs.n1.addEventListener('input', updateDpf);

    // Lambert W0 Function (Principal Branch)
    function lambertW0(z) {
        const minZ = -1 / Math.E;
        if (z < minZ - 1e-9) return NaN; 
        if (Math.abs(z - minZ) < 1e-9) return -1;
        if (Math.abs(z) < 1e-12) return 0;
        
        let w = (z > Math.E) ? Math.log(z) - Math.log(Math.log(z)) : (z >= -0.3 ? z : -0.9);
        for (let i=0; i<50; i++) {
            const ew = Math.exp(w), wew = w*ew;
            w = w - (wew - z)/(ew*(w+1) - (w+2)*(wew-z)/(2*w+2)); // Halley's method
            if (Math.abs(wew - z) < 1e-12) break;
        }
        return w;
    }

    // Calculation Logic
    document.getElementById('calculate-btn').addEventListener('click', () => {
        const r = parseFloat(inputs.r.value);
        const s = parseFloat(inputs.s.value);
        const D1 = parseFloat(inputs.d1.value);
        const n1 = parseFloat(inputs.n1.value);
        const n2 = parseFloat(inputs.n2.value);

        // Validation
        const err = document.getElementById('error-params');
        err.textContent = "";
        if ([r, s, D1, n1, n2].some(isNaN)) {
            err.textContent = "Please fill all fields."; return;
        }

        // 1. Calculate BED of Reference
        // BED = D/(1-r) - (Dq/(1-r))*n*(1 - exp(-s*D/n))
        const one_r = 1 - r;
        const Dq = r / s; // Shoulder displacement
        const d1 = D1 / n1;
        
        // Handle r=0 limit (Linear model)
        let BED1;
        if (Math.abs(r) < 1e-6) BED1 = D1; 
        else BED1 = (D1/one_r) - (Dq * n1 / one_r) * (1 - Math.exp(-s * d1));

        // 2. Solve for D2 using Lambert W
        // K = r + [s(1-r)/n2] * BED1
        // D2 = (n2/s) * (K + W0(-r * exp(-K)))
        const K = r + (s * one_r / n2) * BED1;
        const arg = -r * Math.exp(-K);
        const w_val = lambertW0(arg);

        if (isNaN(w_val)) {
            alert("No solution found (Lambert W argument out of bounds). Check parameters.");
            return;
        }

        const D2 = (n2 / s) * (K + w_val);
        const d2 = D2 / n2;

        // Render Results
        document.getElementById('result-text').textContent = D2.toFixed(2) + " Gy";
        document.getElementById('dose-per-fraction-text').textContent = d2.toFixed(2) + " Gy / fx";
        
        document.getElementById('dbg-bed1').textContent = BED1.toFixed(3);
        document.getElementById('dbg-k').textContent = K.toFixed(3);
        document.getElementById('dbg-w').textContent = w_val.toFixed(4);
        
        const resContainer = document.getElementById('result-container');
        resContainer.classList.remove('hidden');
        resContainer.scrollIntoView({ behavior: 'smooth' });
    });

  });
  </script>
</body>
</html>
