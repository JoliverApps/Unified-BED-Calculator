<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Unified BED Calculator (RD Framework)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <script id="data-source-script" src="./datasrc.js"></script>
  <script>
    window.MathJax = {
      tex: { inlineMath: [['\\(','\\)'], ['$', '$']] },
      options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .error-text { color: #ef4444; font-size: 0.75rem; display: block; margin-top: 0.25rem; font-weight: 500; }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }
    details > summary { cursor: pointer; }
    
    /* Input states */
    input.invalid { border-color: #ef4444; background-color: #fef2f2; }
    input.invalid:focus { --tw-ring-color: #ef4444; border-color: #ef4444; }
    
    /* Disabled/Readonly state override */
    input:disabled { background-color: #f3f4f6; color: #6b7280; cursor: not-allowed; border-color: #e5e7eb; }
    
    .fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>

<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

  <div class="w-full max-w-lg bg-white rounded-xl shadow-lg p-6 md:p-8 space-y-6">
    
    <div class="bg-indigo-50 border-l-4 border-indigo-500 text-indigo-800 p-4 rounded-lg">
      <p class="font-bold text-xs uppercase tracking-wide">RD Framework</p>
      <p class="text-xs mt-1">Converts between Classical ($\alpha, \beta, D_0$) and RD ($r, s, k$) parameters.</p>
    </div>

    <div class="text-center">
      <h1 class="text-2xl md:text-3xl font-bold text-slate-800">Unified BED Calculator</h1>
      <p class="text-slate-500 mt-2 text-sm">Isoeffect via Lambert-$W$</p>
      <div class="my-3 text-sm overflow-x-auto text-slate-600">
        $$ \mathrm{BED}(D,n) = \frac{D}{1-r} - \frac{n D_q}{1-r}\Bigl(1-e^{-s D/n}\Bigr) $$
      </div>
    </div>

    <div class="space-y-4">
      <div class="flex items-center justify-between border-b pb-2">
        <h2 class="text-lg font-semibold text-slate-700">1. Tissue Parameters</h2>
        <div class="flex bg-slate-200 rounded-lg p-1 text-xs font-medium">
            <button id="mode-classical" class="px-3 py-1 rounded-md transition-all shadow-sm bg-white text-slate-800">Classical</button>
            <button id="mode-rd" class="px-3 py-1 rounded-md transition-all text-slate-500 hover:text-slate-700">RD Params</button>
        </div>
      </div>
      
      <div>
        <div class="flex items-center justify-between gap-4">
          <label for="cell-line-select" class="text-sm font-medium text-slate-600">Preset:</label>
          <select id="cell-line-select" class="w-3/5 md:w-2/3 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition text-sm">
            <option value="">Loading data...</option>
          </select>
        </div>
        
        <p id="cell-desc" class="text-xs text-slate-400 mt-2 italic text-right min-h-[1rem]"></p>
        <div id="source-box" class="hidden mt-2 p-3 bg-slate-50 border border-slate-200 rounded text-xs text-slate-600 fade-in">
            <span class="font-bold text-slate-700">Source:</span> <span id="source-text"></span>
        </div>
      </div>

      <div id="group-classical" class="space-y-2 transition-opacity duration-200">
        <div class="flex items-center gap-2 mb-1">
            <span class="text-xs font-bold uppercase text-slate-400">Classical Input</span>
            <div class="h-px bg-slate-200 flex-grow"></div>
        </div>
        <div class="grid grid-cols-3 gap-2">
            <div>
              <label class="block text-xs font-medium text-slate-500 mb-1">\(\alpha\) (Gy\(^{-1}\))</label>
              <input type="number" id="param-alpha" step="any" class="w-full px-2 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm">
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-500 mb-1">\(\beta\) (Gy\(^{-2}\))</label>
              <input type="number" id="param-beta" step="any" class="w-full px-2 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm">
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-500 mb-1">\(D_0\) (Gy)</label>
              <input type="number" id="param-d0" step="any" class="w-full px-2 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm">
            </div>
        </div>
      </div>

      <div id="group-rd" class="space-y-2 transition-opacity duration-200">
        <div class="flex items-center gap-2 mb-1 mt-2">
            <span class="text-xs font-bold uppercase text-slate-400">RD Framework</span>
            <div class="h-px bg-slate-200 flex-grow"></div>
        </div>
        <div class="grid grid-cols-3 gap-2">
            <div>
              <label class="block text-xs font-medium text-slate-500 mb-1">Resilience \(r\)</label>
              <input type="number" id="param-r" step="any" class="w-full px-2 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm">
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-500 mb-1">Sens. \(s\) (1/Gy)</label>
              <input type="number" id="param-s" step="any" class="w-full px-2 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm">
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-500 mb-1">Slope \(k\) (1/Gy)</label>
              <input type="number" id="param-k" step="any" class="w-full px-2 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm">
            </div>
        </div>
      </div>

      <div id="error-container" class="space-y-1 pt-2 border-t border-red-100 hidden"></div>
    </div>

    <div class="space-y-4 p-4 bg-slate-50 border border-slate-200 rounded-lg">
      <h2 class="text-lg font-semibold text-slate-700">2. Reference Schedule</h2>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="text-sm font-medium text-slate-600">Total Dose \(D_1\)</label>
          <input type="number" id="dose-d1" class="w-full mt-1 px-3 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 text-sm" placeholder="> 0">
        </div>
        <div>
          <label class="text-sm font-medium text-slate-600">Fractions \(n_1\)</label>
          <input type="number" id="fractions-n1" class="w-full mt-1 px-3 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 text-sm" placeholder="Integer">
        </div>
      </div>
      <div class="text-xs text-right text-slate-500">
        Dose/Fx: <span id="original-dpf" class="font-bold">--</span> Gy
      </div>
    </div>

    <div class="space-y-2">
      <h2 class="text-lg font-semibold text-slate-700">3. Target Schedule</h2>
      <div class="flex items-center justify-between gap-4">
        <label class="text-sm font-medium text-slate-600">New Fractions \(n_2\):</label>
        <input type="number" id="fractions-n2" class="w-1/3 px-3 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 text-sm" placeholder="Integer">
      </div>
    </div>

    <button id="calculate-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 shadow-lg transition-transform transform active:scale-95">
      Calculate Equivalence
    </button>

    <div id="result-container" class="hidden animate-fade-in mt-6">
      <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-6 text-center">
        <h3 class="text-xs uppercase tracking-wide text-indigo-500 font-bold">Required Total Dose \(D_2\)</h3>
        <p id="result-text" class="text-4xl font-bold text-indigo-700 my-2"></p>
        <p id="dose-per-fraction-text" class="text-lg text-indigo-600 font-medium"></p>
      </div>
      
      <details class="mt-4 border border-slate-200 rounded-lg">
        <summary class="text-xs text-slate-500 p-2 hover:bg-slate-50 font-medium">Show Calculation Details</summary>
        <div class="text-xs text-slate-500 font-mono bg-slate-50 p-3 rounded-b-lg space-y-1">
          <p>BED_ref: <span id="dbg-bed1"></span> Gy</p>
          <p>K_iso: <span id="dbg-k"></span></p>
          <p>W(z): <span id="dbg-w"></span></p>
        </div>
      </details>
    </div>

    <div class="text-center text-xs text-slate-400 pt-6 border-t border-slate-200">
      <p>Data Source: <a href="./datasrc.js" target="_blank" class="underline hover:text-slate-600">datasrc.js</a> | <a href="https://github.com/JoliverApps/Unified-BED-Calculator" class="underline hover:text-slate-600">GitHub Repository</a></p>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    
    // --- 1. DOM Elements ---
    const cellSelect = document.getElementById('cell-line-select');
    const cellDesc = document.getElementById('cell-desc');
    const sourceBox = document.getElementById('source-box');
    const sourceText = document.getElementById('source-text');
    const errorContainer = document.getElementById('error-container');
    const btnModeClassical = document.getElementById('mode-classical');
    const btnModeRD = document.getElementById('mode-rd');

    const inputs = {
        // Classical
        alpha: document.getElementById('param-alpha'),
        beta: document.getElementById('param-beta'),
        d0: document.getElementById('param-d0'),
        // RD
        r: document.getElementById('param-r'),
        s: document.getElementById('param-s'),
        k: document.getElementById('param-k'),
        // Doses
        d1: document.getElementById('dose-d1'),
        n1: document.getElementById('fractions-n1'),
        n2: document.getElementById('fractions-n2')
    };

    // State
    let currentMode = 'classical'; // 'classical' | 'rd'

    // --- 2. Initialize Logic ---
    
    // Load Data
    setTimeout(() => {
        if (typeof window.RD_DATA !== 'undefined') {
            cellSelect.innerHTML = '<option value="">— Select Tumor Type —</option>';
            Object.keys(window.RD_DATA).sort().forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = key;
                cellSelect.appendChild(opt);
            });
        } else {
            cellSelect.innerHTML = '<option value="">Error: datasrc.js not found</option>';
        }
        updateModeUI(); // Set initial UI state
    }, 100);

    // --- 3. Mode Toggle Logic ---
    function setMode(mode) {
        currentMode = mode;
        updateModeUI();
        clearValidation();
    }

    function updateModeUI() {
        const classicalInputs = [inputs.alpha, inputs.beta, inputs.d0];
        const rdInputs = [inputs.r, inputs.s, inputs.k];

        if (currentMode === 'classical') {
            // UI Button State
            btnModeClassical.classList.replace('text-slate-500', 'text-slate-800');
            btnModeClassical.classList.replace('bg-transparent', 'bg-white');
            btnModeClassical.classList.add('shadow-sm');
            
            btnModeRD.classList.replace('text-slate-800', 'text-slate-500');
            btnModeRD.classList.replace('bg-white', 'bg-transparent');
            btnModeRD.classList.remove('shadow-sm');

            // Enable Classical, Disable RD
            classicalInputs.forEach(el => el.disabled = false);
            rdInputs.forEach(el => el.disabled = true);
            
            // Recalculate RD from Classical (ensure consistency)
            convertClassicalToRD();

        } else {
            // UI Button State
            btnModeRD.classList.replace('text-slate-500', 'text-slate-800');
            btnModeRD.classList.replace('bg-transparent', 'bg-white');
            btnModeRD.classList.add('shadow-sm');

            btnModeClassical.classList.replace('text-slate-800', 'text-slate-500');
            btnModeClassical.classList.replace('bg-white', 'bg-transparent');
            btnModeClassical.classList.remove('shadow-sm');

            // Enable RD, Disable Classical
            rdInputs.forEach(el => el.disabled = false);
            classicalInputs.forEach(el => el.disabled = true);

            // Recalculate Classical from RD
            convertRDToClassical();
        }
    }

    btnModeClassical.addEventListener('click', () => setMode('classical'));
    btnModeRD.addEventListener('click', () => setMode('rd'));

    // --- 4. Conversion Logic ---

    function convertClassicalToRD() {
        const alpha = parseFloat(inputs.alpha.value);
        const beta = parseFloat(inputs.beta.value);
        const D0 = parseFloat(inputs.d0.value);

        if (!isNaN(alpha) && !isNaN(beta) && !isNaN(D0) && D0 !== 0) {
            const k = 1 / D0;
            const r = 1 - (alpha * D0);
            
            let s;
            if (Math.abs(r) < 1e-6) {
                 s = 0; // Placeholder
            } else {
                 s = (2 * beta) / (r * k);
            }

            inputs.k.value = k.toFixed(4);
            inputs.r.value = r.toFixed(4);
            inputs.s.value = s.toFixed(4);
            validateParameters(r, s, k);
        }
    }

    function convertRDToClassical() {
        const r = parseFloat(inputs.r.value);
        const s = parseFloat(inputs.s.value);
        const k = parseFloat(inputs.k.value);

        if (!isNaN(r) && !isNaN(s) && !isNaN(k)) {
            const D0 = 1 / k;
            const alpha = k * (1 - r);
            const beta = (r * s * k) / 2;

            inputs.d0.value = D0.toFixed(4);
            inputs.alpha.value = alpha.toFixed(4);
            inputs.beta.value = beta.toFixed(4);
            validateParameters(r, s, k); 
        }
    }

    // --- 5. Event Listeners for Resetting Custom Status ---

    // Common function to reset dropdown if user edits data
    function handleUserEdit() {
        if (cellSelect.value !== "") {
            cellSelect.value = ""; // Reset dropdown to default
            cellDesc.textContent = ""; // Clear description
            sourceBox.classList.add('hidden'); // Hide source
        }
    }

    // Live Input Listeners for Logic + UI Reset
    [inputs.alpha, inputs.beta, inputs.d0].forEach(el => {
        el.addEventListener('input', () => {
            handleUserEdit(); // <--- RESET DROPDOWN
            if (currentMode === 'classical') convertClassicalToRD();
        });
    });

    [inputs.r, inputs.s, inputs.k].forEach(el => {
        el.addEventListener('input', () => {
            handleUserEdit(); // <--- RESET DROPDOWN
            if (currentMode === 'rd') convertRDToClassical();
        });
    });


    // --- 6. Data Loading (Preset Selection) ---
    cellSelect.addEventListener('change', () => {
        clearValidation();
        const key = cellSelect.value;
        if (key && window.RD_DATA[key]) {
            const data = window.RD_DATA[key];
            
            // Populate Classical Fields
            inputs.alpha.value = data.alpha;
            inputs.beta.value = data.beta;
            inputs.d0.value = data.D0;
            
            cellDesc.textContent = data.desc || "";
            if(data.source) {
                sourceText.innerHTML = data.source;
                sourceBox.classList.remove('hidden');
            } else {
                sourceBox.classList.add('hidden');
            }

            // Trigger conversion to populate RD fields
            convertClassicalToRD(); 

        } else {
            // If user selects the "---Select---" option manually
            Object.values(inputs).forEach(i => { if(i.id.startsWith('param')) i.value = ''; });
            cellDesc.textContent = "";
            sourceBox.classList.add('hidden');
        }
    });

    // --- 7. Helper Functions ---

    function clearValidation() {
        Object.values(inputs).forEach(el => el.classList.remove('invalid'));
        errorContainer.innerHTML = '';
        errorContainer.classList.add('hidden');
        document.getElementById('calculate-btn').disabled = false;
        document.getElementById('calculate-btn').classList.remove('opacity-50', 'cursor-not-allowed');
    }

    function addError(msg) {
        const p = document.createElement('p');
        p.className = 'error-text';
        p.textContent = msg;
        errorContainer.appendChild(p);
        errorContainer.classList.remove('hidden');
        
        // Disable Calculate Button
        const btn = document.getElementById('calculate-btn');
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
    }

    function validateParameters(r, s, k) {
        clearValidation();
        let valid = true;
        
        if (r >= 1) {
            addError("Parameter Error: Resilience (r) must be < 1.0. High r implies non-physical negative alpha.");
            if(inputs.r) inputs.r.classList.add('invalid');
            valid = false;
        }

        if (s <= 0) {
            addError("Parameter Error: Sensitization (s) must be strictly positive.");
            if(inputs.s) inputs.s.classList.add('invalid');
            valid = false;
        }

        if (k <= 0) {
            addError("Parameter Error: Slope (k) must be strictly positive.");
            if(inputs.k) inputs.k.classList.add('invalid');
            valid = false;
        }
        
        return valid;
    }

    function updateDpf() {
        const d = parseFloat(inputs.d1.value);
        const n = parseFloat(inputs.n1.value);
        const lbl = document.getElementById('original-dpf');
        if (d > 0 && n > 0) lbl.textContent = (d/n).toFixed(2);
        else lbl.textContent = "--";
    }
    inputs.d1.addEventListener('input', updateDpf);
    inputs.n1.addEventListener('input', updateDpf);

    // --- 8. Calculation ---
    
    // Lambert W0
    function lambertW0(z) {
        const minZ = -1 / Math.E;
        if (z < minZ - 1e-9) return NaN; 
        if (Math.abs(z - minZ) < 1e-9) return -1;
        if (Math.abs(z) < 1e-12) return 0;
        
        let w = (z > Math.E) ? Math.log(z) - Math.log(Math.log(z)) : (z >= -0.3 ? z : -0.9);
        for (let i=0; i<50; i++) {
            const ew = Math.exp(w), wew = w*ew;
            w = w - (wew - z)/(ew*(w+1) - (w+2)*(wew-z)/(2*w+2));
            if (Math.abs(wew - z) < 1e-12) break;
        }
        return w;
    }

    document.getElementById('calculate-btn').addEventListener('click', () => {
        const r = parseFloat(inputs.r.value);
        const s = parseFloat(inputs.s.value);
        const k = parseFloat(inputs.k.value);
        
        if (!validateParameters(r, s, k)) return;

        const D1 = parseFloat(inputs.d1.value);
        const n1 = parseFloat(inputs.n1.value);
        const n2 = parseFloat(inputs.n2.value);

        if (!D1 || !n1 || !n2 || D1<=0 || n1<=0 || n2<=0 || !Number.isInteger(n1) || !Number.isInteger(n2)) {
             if(!D1 || D1<=0) inputs.d1.classList.add('invalid');
             if(!n1 || n1<=0) inputs.n1.classList.add('invalid');
             if(!n2 || n2<=0) inputs.n2.classList.add('invalid');
             return;
        }

        const one_r = 1 - r;
        const Dq = r / s;
        const d1 = D1 / n1;
        
        let BED1;
        if (Math.abs(r) < 1e-6) BED1 = D1; 
        else BED1 = (D1/one_r) - (Dq * n1 / one_r) * (1 - Math.exp(-s * d1));

        const K = r + (s * one_r / n2) * BED1;
        const arg = -r * Math.exp(-K);
        const w_val = lambertW0(arg);

        if (isNaN(w_val)) {
            addError("Calculation Error: Result implies impossible physical state (Lambert W failure).");
            return;
        }

        const D2 = (n2 / s) * (K + w_val);
        const d2 = D2 / n2;

        document.getElementById('result-text').textContent = D2.toFixed(2) + " Gy";
        document.getElementById('dose-per-fraction-text').textContent = d2.toFixed(2) + " Gy / fx";
        
        document.getElementById('dbg-bed1').textContent = BED1.toFixed(3);
        document.getElementById('dbg-k').textContent = K.toFixed(3);
        document.getElementById('dbg-w').textContent = w_val.toFixed(4);
        
        const resContainer = document.getElementById('result-container');
        resContainer.classList.remove('hidden');
        resContainer.scrollIntoView({ behavior: 'smooth' });
    });

  });
  </script>
</body>
</html>
